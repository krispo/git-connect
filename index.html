<!DOCTYPE html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://rawgit.com/krispo/git-connect/master/git-connect.js"></script>
    <script src="https://rawgit.com/michael/github/v0.10.7/github.js"></script>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
</head>
<style>
    .container1 {text-align: center; margin:50px;}
    button {width: 300px; height: 100px;}
    #t1 {margin: 0px 25% 0px 25%; width:50%;}
    #projects {width: 100%;}
    #projects .pname {width: 50%;}
</style>
<body>

<h3 style="text-align: center;">
    <div>OAuth connection to Github without backend-side (but with using <a href="https://github.com/krispo/git-proxy" target="_blank">proxy</a>).</div>
    Read more on <a href="https://github.com/krispo/git-connect" target="_blank">github</a>.
</h3>

<div class="container1">
    <button id="git-connect-btn" onclick="connection.toggle()">TOGGLE</button>
</div>

<table id="t1">
    <tr>
        <td style="width:100%;float: right;text-align: right;margin-right: 20px;"><img id="avatar" style="width: 47px;height:47px;"><div id="username">Guest</div></td>
        <td style="width: 100%; vertical-align: top;"><h4 style="margin:0px 0px 0px 0px;">Projects</h4><div style="border-style: solid;border-width: 1px;"><table id="projects"><tr><td>Empty List</td></tr></table></div></td>
    </tr>
</table>

<script>
    document.addEventListener('IsConnectedToGithubEvent', function(e){
        $('#git-connect-btn').css('background-color', 'rgba(138, 206, 135, 0.64)').text('DISCONNECT from GITHUB');
        e.detail.withCredentials(function(err, username, access_token, userinfo){
            $("#avatar").attr('src', userinfo['avatar_url']);
            $("#username").text(username);

            //initialize github api
            var github = new Github({
                token: access_token,
                auth: "oauth"
            });
            github.getUser().repos(function(err, repos){
                if (!repos.length) return;
                var projects = $("#projects").html('');
                for(i=0;i<repos.length;i++){
                    projects.append(
                            '<tr>' +
                                    '<td class="pname"><a href="'+repos[i].html_url+'">'+repos[i].name+'</a>'+(repos[i].owner.login !== username?'&nbsp; ('+repos[i].owner.login+')':'')+'</td>' +
                                    '<td>'+repos[i].language+'</td>' +
                                    '<td><i class="fa fa-star"></i> '+repos[i].stargazers_count+'</td>' +
                                    '<td><i class="fa fa-code-fork"></i> '+repos[i].forks_count+'</td>' +
                            '</tr>');
                }
            });
        })
    });
    document.addEventListener('IsDisconnectedFromGithubEvent', function(e){
        $('#git-connect-btn').css('background-color','rgba(247, 104, 72, 0.37)').text('CONNECT to GITHUB');
    })

    var connection = window.connection({
        client_id: "27ac5fbe4ee2ef2844ea", //krispo/git-connect, prod
        //client_id: "d24d65af8f05dd6f5cb7", //localhost, dev
        proxy: "http://git-proxy.herokuapp.com"
    });
</script>
</body>
</html>